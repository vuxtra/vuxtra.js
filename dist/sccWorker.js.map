{"version":3,"file":"sccWorker.js","sources":["../lib/vuxtraserver/controllers/controller.js","../lib/vuxtraserver/controllers/serviceController.js","../lib/vuxtraserver/vuxtraServer.js","../node_modules/nuxt/lib/common/utils.js","../lib/builder/webpack/vuxtraServer.config.js","../lib/builder/index.js","../lib/socketserver/sccWorker.js"],"sourcesContent":["import Tapable from 'tapable'\n\nexport default class Controller extends Tapable {\n    constructor (_options, _socket) {\n        super()\n        this.options    = _options\n        this.socket     = _socket\n    }\n\n }","import Controller from './controller'\nimport { ServiceRequest } from '@vuxtra/shared-core'\nimport { ServiceResponse } from '@vuxtra/shared-core'\nimport { join, resolve, basename, dirname } from 'path'\nimport _ from 'lodash'\n\nexport default class ServiceController extends Controller {\n    constructor (_options) {\n        super(_options)\n    }\n\n    process (data, res) {\n        let request = new ServiceRequest(data)\n\n        let response = new ServiceResponse()\n        response.setId(request.getId())\n        response.ssSuccess()\n        response.setServiceName(request.getServiceName())\n        response.setServiceAction(request.getServiceAction())\n\n        let type = request.getType()\n\n        if (type === null || type !== 'service' || request.getServiceName() === null) {\n            response.ssClientErrorInvalidRequest()\n            res(null, response)\n            return\n        }\n\n        let absoluteServicePath =  join(this.options.buildDir, 'server', request.getServiceName() + '.js')\n\n        try {\n            let service = require(resolve(absoluteServicePath)).default\n\n            if (typeof service[request.getServiceAction()] === 'undefined' || service[request.getServiceAction()] === null) {\n                response.ssClientErrorNotFound(`service ${request.getServiceName()} does not contain action ${request.getServiceAction()}`)\n                res(null, response)\n                return\n            }\n\n            let ctx = {request, response}\n\n            // here we process it weather is sync or async\n            Promise.resolve(service[request.getServiceAction()].apply(ctx, _.values(request.getData()))).then(result => {\n                response.setData(result)\n                res(null, response)\n            });\n\n        } catch (e) {\n            if (e.code === 'MODULE_NOT_FOUND') {\n                response.ssClientErrorNotFound(`service name ${request.getServiceName()} not found`)\n                res(null, response)\n                return\n            }\n            response.ssServerError(e.message)\n            res(null, response)\n            return\n        }\n    }\n\n}","import Tapable from 'tapable'\nimport AsyncParallelHook from 'tapable/lib/AsyncParallelHook'\nimport _ from 'lodash'\nimport ServiceController from \"./controllers/serviceController\";\n\nexport default class VuxtraServer extends Tapable {\n    constructor (options) {\n        super()\n        // setup available hooks\n        this.hooks = {\n            init: new AsyncParallelHook([\"vuxtraServer\"]),\n            ready: new AsyncParallelHook([\"vuxtraServer\"]),\n            socketConnection: new AsyncParallelHook([\"socket\"])\n        };\n        this.options = options\n        this.socketServer = null\n        this.serviceController = null\n\n    }\n\n    registerSocketServer(socketServer) {\n        // lets make sure proper interface is followed\n\n        if (!_.hasIn(socketServer, [\n                'exchange',\n                'on'\n        ])) {\n            throw Error('Not a valid socket server, make sure your object declares proper interface')\n        }\n        this.socketServer = socketServer\n    }\n\n    run() {\n        this.hooks.init.promise(this);\n        if (this.socketServer === null) {\n            throw Error('SocketServer should be setup and registered first with registerSocketServer')\n        }\n\n        this.socketServer.on('connection',  (socket) => {\n\n            this.hooks.socketConnection.promise(socket);\n\n            this.processServiceRequest(socket)\n\n            var interval = setInterval(function () {\n                socket.emit('rand', {\n                    rand: Math.floor(Math.random() * 5)\n                })\n            }, 1000)\n\n            socket.on('disconnect', function () {\n                clearInterval(interval)\n            })\n        })\n\n        this.hooks.ready.promise(this);\n    }\n\n    processServiceRequest(socket) {\n        // process service calls\n        socket.on('service.call', (data, res) => {\n            if (this.serviceController === null) {\n                this.serviceController = new ServiceController(this.options, socket)\n            }\n\n            this.serviceController.process(data, res)\n        })\n    }\n}","import { resolve, relative, sep } from 'path'\nimport _ from 'lodash'\n\nexport function encodeHtml (str) {\n  return str.replace(/</g, '&lt;').replace(/>/g, '&gt;')\n}\n\nexport function getContext (req, res) {\n  return { req, res }\n}\n\nexport function setAnsiColors (ansiHTML) {\n  ansiHTML.setColors({\n    reset: ['efefef', 'a6004c'],\n    darkgrey: '5a012b',\n    yellow: 'ffab07',\n    green: 'aeefba',\n    magenta: 'ff84bf',\n    blue: '3505a0',\n    cyan: '56eaec',\n    red: '4e053a'\n  })\n}\n\nexport async function waitFor (ms) {\n  return new Promise(function (resolve) {\n    setTimeout(resolve, (ms || 0))\n  })\n}\n\nexport function urlJoin () {\n  return [].slice.call(arguments).join('/').replace(/\\/+/g, '/').replace(':/', '://')\n}\n\nexport function isUrl (url) {\n  return (url.indexOf('http') === 0 || url.indexOf('//') === 0)\n}\n\nexport function promisifyRoute (fn) {\n  // If routes is an array\n  if (Array.isArray(fn)) {\n    return Promise.resolve(fn)\n  }\n  // If routes is a function expecting a callback\n  if (fn.length === 1) {\n    return new Promise((resolve, reject) => {\n      fn(function (err, routeParams) {\n        if (err) {\n          reject(err)\n        }\n        resolve(routeParams)\n      })\n    })\n  }\n  let promise = fn()\n  if (!promise || (!(promise instanceof Promise) && (typeof promise.then !== 'function'))) {\n    promise = Promise.resolve(promise)\n  }\n  return promise\n}\n\nexport function sequence (tasks, fn) {\n  return tasks.reduce((promise, task) => promise.then(() => fn(task)), Promise.resolve())\n}\n\nexport function parallel (tasks, fn) {\n  return Promise.all(tasks.map(task => fn(task)))\n}\n\nexport function chainFn (base, fn) {\n  /* istanbul ignore if */\n  if (!(fn instanceof Function)) {\n    return\n  }\n  return function () {\n    if (typeof base !== 'function') {\n      return fn.apply(this, arguments)\n    }\n    let baseResult = base.apply(this, arguments)\n    // Allow function to mutate the first argument instead of returning the result\n    if (baseResult === undefined) {\n      baseResult = arguments[0]\n    }\n    let fnResult = fn.call(this, baseResult, ...Array.prototype.slice.call(arguments, 1))\n    // Return mutated argument if no result was returned\n    if (fnResult === undefined) {\n      return baseResult\n    }\n    return fnResult\n  }\n}\n\nexport function isPureObject (o) {\n  return !Array.isArray(o) && typeof o === 'object'\n}\n\nexport const isWindows = /^win/.test(process.platform)\n\nexport function wp (p = '') {\n  /* istanbul ignore if */\n  if (isWindows) {\n    return p.replace(/\\\\/g, '\\\\\\\\')\n  }\n  return p\n}\n\nexport function wChunk (p = '') {\n  /* istanbul ignore if */\n  if (isWindows) {\n    return p.replace(/\\//g, '\\\\\\\\')\n  }\n  return p\n}\n\nconst reqSep = /\\//g\nconst sysSep = _.escapeRegExp(sep)\nconst normalize = string => string.replace(reqSep, sysSep)\n\nexport function r () {\n  let args = Array.prototype.slice.apply(arguments)\n  let lastArg = _.last(args)\n\n  if (lastArg.includes('@') || lastArg.includes('~')) {\n    return wp(lastArg)\n  }\n\n  return wp(resolve(...args.map(normalize)))\n}\n\nexport function relativeTo () {\n  let args = Array.prototype.slice.apply(arguments)\n  let dir = args.shift()\n\n  // Resolve path\n  let path = r(...args)\n\n  // Check if path is an alias\n  if (path.includes('@') || path.includes('~')) {\n    return path\n  }\n\n  // Make correct relative path\n  let rp = relative(dir, path)\n  if (rp[0] !== '.') {\n    rp = './' + rp\n  }\n  return wp(rp)\n}\n\nexport function flatRoutes (router, path = '', routes = []) {\n  router.forEach((r) => {\n    if (!r.path.includes(':') && !r.path.includes('*')) {\n      /* istanbul ignore if */\n      if (r.children) {\n        flatRoutes(r.children, path + r.path + '/', routes)\n      } else {\n        routes.push((r.path === '' && path[path.length - 1] === '/' ? path.slice(0, -1) : path) + r.path)\n      }\n    }\n  })\n  return routes\n}\n\nexport function cleanChildrenRoutes (routes, isChild = false) {\n  let start = -1\n  let routesIndex = []\n  routes.forEach((route) => {\n    if (/-index$/.test(route.name) || route.name === 'index') {\n      // Save indexOf 'index' key in name\n      let res = route.name.split('-')\n      let s = res.indexOf('index')\n      start = (start === -1 || s < start) ? s : start\n      routesIndex.push(res)\n    }\n  })\n  routes.forEach((route) => {\n    route.path = (isChild) ? route.path.replace('/', '') : route.path\n    if (route.path.indexOf('?') > -1) {\n      let names = route.name.split('-')\n      let paths = route.path.split('/')\n      if (!isChild) {\n        paths.shift()\n      } // clean first / for parents\n      routesIndex.forEach((r) => {\n        let i = r.indexOf('index') - start //  children names\n        if (i < paths.length) {\n          for (let a = 0; a <= i; a++) {\n            if (a === i) {\n              paths[a] = paths[a].replace('?', '')\n            }\n            if (a < i && names[a] !== r[a]) {\n              break\n            }\n          }\n        }\n      })\n      route.path = (isChild ? '' : '/') + paths.join('/')\n    }\n    route.name = route.name.replace(/-index$/, '')\n    if (route.children) {\n      if (route.children.find((child) => child.path === '')) {\n        delete route.name\n      }\n      route.children = cleanChildrenRoutes(route.children, true)\n    }\n  })\n  return routes\n}\n\nexport function createRoutes (files, srcDir) {\n  let routes = []\n  files.forEach((file) => {\n    let keys = file.replace(/^pages/, '').replace(/\\.vue$/, '').replace(/\\/{2,}/g, '/').split('/').slice(1)\n    let route = { name: '', path: '', component: r(srcDir, file) }\n    let parent = routes\n    keys.forEach((key, i) => {\n      route.name = route.name ? route.name + '-' + key.replace('_', '') : key.replace('_', '')\n      route.name += (key === '_') ? 'all' : ''\n      route.chunkName = file.replace(/\\.vue$/, '')\n      let child = _.find(parent, { name: route.name })\n      if (child) {\n        child.children = child.children || []\n        parent = child.children\n        route.path = ''\n      } else {\n        if (key === 'index' && (i + 1) === keys.length) {\n          route.path += (i > 0 ? '' : '/')\n        } else {\n          route.path += '/' + (key === '_' ? '*' : key.replace('_', ':'))\n          if (key !== '_' && key.indexOf('_') !== -1) {\n            route.path += '?'\n          }\n        }\n      }\n    })\n    // Order Routes path\n    parent.push(route)\n    parent.sort((a, b) => {\n      if (!a.path.length || a.path === '/') {\n        return -1\n      }\n      if (!b.path.length || b.path === '/') {\n        return 1\n      }\n      let i = 0\n      let res = 0\n      let y = 0\n      let z = 0\n      const _a = a.path.split('/')\n      const _b = b.path.split('/')\n      for (i = 0; i < _a.length; i++) {\n        if (res !== 0) {\n          break\n        }\n        y = _a[i] === '*' ? 2 : (_a[i].indexOf(':') > -1 ? 1 : 0)\n        z = _b[i] === '*' ? 2 : (_b[i].indexOf(':') > -1 ? 1 : 0)\n        res = y - z\n        // If a.length >= b.length\n        if (i === _b.length - 1 && res === 0) {\n          // change order if * found\n          res = _a[i] === '*' ? -1 : 1\n        }\n      }\n      return res === 0 ? (_a[i - 1] === '*' && _b[i] ? 1 : -1) : res\n    })\n  })\n  return cleanChildrenRoutes(routes)\n}\n","import { cloneDeep } from 'lodash'\nimport { join, resolve } from 'path'\nimport { each } from 'lodash'\nimport { existsSync } from 'fs'\nimport webpack from 'webpack'\nimport nodeExternals from 'webpack-node-externals'\n\nexport default function vuxtraServerConfig (entryFiles) {\n    const nodeModulesDir = join(__dirname, '..', 'node_modules')\n\n    let env = {\n        debug: true\n    }\n    each(this.options.env, (value, key) => {\n        env['process.env.' + key] = (['boolean', 'number'].indexOf(typeof value) !== -1 ? value : JSON.stringify(value))\n    })\n\n  let outputPath = resolve(this.options.buildDir, 'server')\n\n    console.log()\n\n    const config = {\n        name: 'vuxtra-server',\n        target: 'node',\n        node: false,\n        devtool: 'source-map',\n        entry: entryFiles,\n        output: {\n            path: outputPath,\n            filename: '[name].js',\n            chunkFilename: '[name].[chunkhash].js',\n            libraryTarget: 'commonjs2'\n        },\n        performance: {\n            maxEntrypointSize: 1000000,\n            hints: false,\n            maxAssetSize: Infinity\n        },\n        resolve: {\n            extensions: ['.js', '.json', '.ts'],\n            alias: {\n                '~': join(this.options.srcDir),\n                '~~': join(this.options.rootDir),\n                '@': join(this.options.srcDir),\n                '@@': join(this.options.rootDir),\n            },\n            modules: [\n                this.options.modulesDir,\n                nodeModulesDir\n            ]\n        },\n        resolveLoader: {\n            modules: [\n                this.options.modulesDir,\n                nodeModulesDir\n            ]\n        },\n        module: {\n            noParse: /es6-promise\\.js$/, // Avoid webpack shimming process\n            rules: [\n                {\n                    test: /\\.js$/,\n                    loader: 'babel-loader',\n                    exclude: /node_modules/,\n                    options: Object.assign({}, this.babelOptions)\n                },\n            ]\n        },\n        externals: [],\n        plugins: (this.options.build.plugins || []).concat([\n            new webpack.DefinePlugin(Object.assign(env, {\n                debug: true\n            }))\n        ])\n    }\n\n    // Workaround for hiding Warnings about plugins without a default export (#1179)\n    config.plugins.push({\n        apply (compiler) {\n            compiler.plugin('done', stats => {\n                stats.compilation.warnings = stats.compilation.warnings.filter(warn => {\n                    if (warn.name === 'ModuleDependencyWarning' && warn.message.includes(`export 'default'`) && warn.message.includes('plugin')) {\n                        return false\n                    }\n                    return true\n                })\n            })\n        }\n    })\n\n    // https://webpack.js.org/configuration/externals/#externals\n    // https://github.com/liady/webpack-node-externals\n    const moduleDirs = [\n        this.options.modulesDir\n        // Temporary disabled due to vue-server-renderer module search limitations\n        // resolve(__dirname, '..', 'node_modules')\n    ]\n    moduleDirs.forEach(dir => {\n        if (existsSync(dir)) {\n            config.externals.push(nodeExternals({\n                // load non-javascript files with extensions, presumably via loaders\n                whitelist: [/es6-promise|\\.(?!(?:js|json)$).{1,5}$/i],\n                modulesDir: dir\n            }))\n        }\n    })\n\n    // --------------------------------------\n    // Dev specific config\n    // --------------------------------------\n    if (this.options.dev) {\n        //\n    }\n\n    // --------------------------------------\n    // Production specific config\n    // --------------------------------------\n    if (!this.options.dev) {\n        config.plugins.push(\n            new webpack.LoaderOptionsPlugin({\n                minimize: true\n            })\n        )\n    }\n\n    // Clone deep avoid leaking config between Client and Server\n    return cloneDeep(config)\n}\n","import fs, { remove, readFile, writeFile, mkdirp, utimes, existsSync } from 'fs-extra'\nimport Tapable from 'tapable'\nimport chokidar from 'chokidar'\nimport glob from 'glob'\nimport AsyncParallelHook from 'tapable/lib/AsyncParallelHook'\nimport webpack from 'webpack'\nimport { join, resolve, basename, dirname } from 'path'\nimport { r, sequence } from 'nuxt/lib/common/utils'\nimport Exval from 'exval'\n// import MFS from 'memory-fs'\nimport _ from 'lodash'\n\nimport Debug from 'debug'\n\nconst debug = Debug('vuxtra:build')\ndebug.color = 2 // Force green color\n\nimport vuxtraServerWebpackConfig from './webpack/vuxtraServer.config'\n\nexport default class VuxtraBuilder extends Tapable {\n    constructor (_options) {\n        super()\n\n        // setup available hooks\n        this.hooks = {\n            init: new AsyncParallelHook([\"builder\"]),\n            built: new AsyncParallelHook([\"builder\"]),\n            compile: new AsyncParallelHook([\"compiler\"]),\n            pluginDone: new AsyncParallelHook([\"compiler\"]),\n            compileDone: new AsyncParallelHook([\"compiler\"])\n        };\n\n        this.options    = _options\n        this.compiler   = null\n    }\n\n    async build() {\n        debug('...building vuxtraServer')\n        await this.hooks.init.promise(this)\n\n        // Babel options\n        this.babelOptions = _.defaults(this.options.build.babel, {\n            babelrc: false,\n            cacheDirectory: !!this.options.dev\n        })\n        if (!this.babelOptions.babelrc && !this.babelOptions.presets) {\n            this.babelOptions.presets = [\n                require.resolve('babel-preset-vue-app')\n            ]\n        }\n\n        // Check if server dir exists and warn if not\n        if (!fs.existsSync(join(this.options.srcDir, 'server'))) {\n            let dir = this.options.srcDir\n            if (fs.existsSync(resolve(this.options.srcDir, '..', 'server'))) {\n                throw new Error(`No \\`server\\` directory found in ${dir}. Did you mean to run \\`vuxtra\\` in the parent (\\`../\\`) directory?`)\n            } else {\n                throw new Error(`Couldn't find a \\`server\\` directory in ${dir}. Please create one under the project root`)\n            }\n        }\n\n        // lets setup a watcher\n        // this.options.build.watch.push(join(this.options.srcDir, 'server/**/*.js'))\n\n        debug(`App root: ${this.options.srcDir}`)\n        debug(`Generating ${this.options.buildDir} files...`)\n\n        await this.setupBuildDir()\n        await this.buildWebpack()\n\n        await this.hooks.built.promise(this);\n\n    }\n\n    async setupBuildDir() {\n        // Create .vuxtra/, .vuxtra/services and other folders\n        await remove(r(this.options.buildDir))\n        await mkdirp(r(this.options.buildDir, 'server'))\n        if (!this.options.dev) {\n            await mkdirp(r(this.options.buildDir, 'dist'))\n        }\n    }\n\n\n    async generateFiles (entryFiles) {\n        let serviceObj = {}\n        _.forEach(entryFiles, (filePath, path) => {\n\n            let pathSections = _.trim(path, '/').split('/')\n\n            switch (pathSections[0]) {\n                case 'services':\n                    // lets load up file\n\n                    let entryFileObj = {}\n                    let remoteObj = require(join(this.options.buildDir, 'server', _.trimEnd(path,'/')+'.js')).default\n                    _.forIn(remoteObj, (value,key) => {\n                        entryFileObj[key] = path\n                    })\n\n                    // function () {\n                    //     return $_internalService(arguments, this.$__vuxtra_enpoint_options)\n                    // }\n\n                    _.set(serviceObj, _.replace(_.trim(join.apply(null, pathSections.slice(1)), '/'), /\\//g, '.'), entryFileObj)\n                    break\n\n            }\n\n        })\n\n        var templateFn = _.template(`{ <% _.each(model, function(val, index) { %> '<%= index %>' : <% if (_.isObject( val )) { %> <%= templateFn({ model: val, templateFn: templateFn }) %> <% }  else  { %> function () {\n                return $_internalService(arguments, '<%= val %>', '<%= index %>')\n           } <% } %>, <% }); %> }`);\n\n        const fileContent = await readFile(join(__dirname, '../lib/builder/templates/client.js'), 'utf8')\n        const template = _.template(fileContent)\n\n        let exval = new Exval()\n\n        const content = template({\n            serviceObj: templateFn({ model: serviceObj, templateFn: templateFn })\n        })\n\n        let clientPathJs = r(this.options.buildDir, 'clientVuxtra.js')\n        await writeFile(clientPathJs, content, 'utf8')\n\n    }\n\n    async buildWebpack (resetFolders = false) {\n        debug('Building files...')\n        console.log('...compiling vuxtra files')\n        const compilersOptions = []\n\n        if (resetFolders) {\n            await this.setupBuildDir()\n        }\n\n        let entryFiles = glob.sync(`${this.options.srcDir}/server/+(services|models|resources)/**/*.js`).reduce((entries, entry) => Object.assign(entries, {[entry.replace(this.options.srcDir+'/server', '').replace('.js', '')]: entry}), {})\n\n        if (!_.isEmpty(entryFiles)) {\n            // vuxtra default compiler\n            const vuxtraCompilerConfig = vuxtraServerWebpackConfig.call(this, entryFiles)\n            compilersOptions.push(vuxtraCompilerConfig)\n        }\n\n\n        // Simulate webpack multi compiler interface\n        // Separate compilers are simpler, safer and faster\n        this.compiler = { compilers: [] }\n        this.compiler.plugin = (...args) => {\n            this.compiler.compilers.forEach(compiler => {\n                compiler.plugin(...args)\n            })\n        }\n\n        // Initialize shared FS and Cache\n        // const sharedFS = this.options.dev && new MFS()\n        const sharedFS = false // disable shared fs for now\n        const sharedCache = {}\n\n        // Initialize compilers\n        compilersOptions.forEach(compilersOption => {\n            const compiler = webpack(compilersOption)\n            if (sharedFS && !compiler.name.includes('-dll')) {\n                compiler.outputFileSystem = sharedFS\n            }\n            compiler.cache = sharedCache\n            this.compiler.compilers.push(compiler)\n        })\n\n        // Access to compilers with name\n        this.compiler.compilers.forEach(compiler => {\n            if (compiler.name) {\n                this.compiler[compiler.name] = compiler\n            }\n        })\n\n        // Run after each compile\n        this.compiler.plugin('done', async stats => {\n            // Don't reload failed builds\n            if (stats.hasErrors()) {\n                return\n            }\n\n            // console.log(stats.toString({ chunks: true }))\n\n            await this.hooks.pluginDone.promise(this);\n        })\n\n        await this.hooks.compile.promise(this);\n\n        // Start Builds\n        await sequence(this.compiler.compilers, compiler => new Promise((resolve, reject) => {\n            if (this.options.dev) {\n                // Build and watch for changes\n\n                compiler.watch(this.options.watchers.webpack, (err) => {\n                    if (err) {\n                        return reject(err)\n                    }\n                    resolve()\n                })\n\n            } else {\n                // --- Production Build ---\n                compiler.run((err, stats) => {\n                    if (err) {\n                        return reject(err)\n                    }\n                    if (err) return console.error(err) // eslint-disable-line no-console\n\n                    // Show build stats for production\n                    console.log(stats.toString(this.webpackStats)) // eslint-disable-line no-console\n\n                    if (stats.hasErrors()) {\n                        return reject(new Error('Webpack build exited with errors'))\n                    }\n                    resolve()\n                })\n            }\n        }))\n\n\n        await this.generateFiles(entryFiles)\n\n        await this.hooks.compileDone.promise(this);\n\n    }\n\n    watchDev() {\n        const patterns = [\n            r(this.options.srcDir, 'server/services/**/*'),\n        ]\n        const options = Object.assign({}, this.options.watchers.chokidar, {\n            ignoreInitial: true\n        })\n        const refreshWebpack = _.debounce(() => {\n                console.log('refreshing webpack...')\n                this.buildWebpack()\n            }\n            , 2000\n        )\n\n        const refreshWebpackReset = _.debounce(() => {\n                this.buildWebpack(true)\n            }\n            , 2000\n        )\n\n        // Watch for src Files\n        let filesWatcher = chokidar.watch(patterns, options)\n            .on('add', refreshWebpack)\n            .on('unlink', refreshWebpackReset)\n            .on('change', refreshWebpack)\n\n    }\n}","import express from 'express'\nimport path from 'path'\nimport morgan from 'morgan'\nimport healthChecker from 'sc-framework-health-check'\nimport Debug from 'debug'\nimport { Nuxt, Builder as NuxtBuilder} from 'nuxt'\nimport VuxtraServer from './../vuxtraserver/vuxtraServer'\nimport VuxtraBuilder from './../builder'\nimport _ from 'lodash'\n\n\nconst debug = Debug('scc-worker:')\ndebug.color = 5\n\n\nmodule.exports.run = function (worker) {\n    debug('   >> Worker PID:', process.pid)\n    var environment = worker.options.environment\n\n    var app = express()\n\n    var httpServer = worker.httpServer\n    var scServer = worker.scServer\n\n    process.on('unhandledRejection', (reason, p) => {\n        //console.log('Unhandled Rejection at: Promise', p, 'reason:', reason);\n        worker.sendToMaster({type: 'error', subtype: 'worker', e:p, message: reason})\n    });\n\n    if (environment == 'dev') {\n        // Log every HTTP request. See https://github.com/expressjs/morgan for other\n        // available formats.\n        app.use(morgan('dev'))\n    }\n\n    // Import and Set vuxtra and nuxt options\n    let config = worker.options.__full_deep_temp_options\n\n    if (!_.isArray(config.nuxt.modules)) {\n        config.nuxt.modules = []\n    }\n\n    // main vuxtra module\n    config.nuxt.modules.push(\n        {\n            src:  '@vuxtra/nuxt-client-module/lib/index',\n            options: config\n        })\n\n    if (!_.isArray(config.nuxt.build)) {\n        config.nuxt.build = []\n\n        if (!_.isArray(config.nuxt.build.templates)) {\n            config.nuxt.build.templates = []\n        }\n    }\n\n    config.nuxt.build.templates.push('./.vuxtra/clientVuxtra.js')\n\n    // Init Nuxt.js\n    const nuxt = new Nuxt(config.nuxt)\n\n    let builderPromise = new Promise((resolve, reject) => {\n\n        // Build only in dev mode\n        if (config.vuxtra.dev) {\n            const vuxtraBuilder = new VuxtraBuilder(config.vuxtra)\n            vuxtraBuilder.build().then(() => {\n                worker.sendToMaster({type: 'event', subtype: 'vuxtraBuilt', message: 'Vuxtra has been built'})\n                vuxtraBuilder.watchDev()\n                // Build only in dev mode\n                if (config.nuxt.dev) {\n                    const nuxtBuilder = new NuxtBuilder(nuxt)\n                    nuxtBuilder.build().then(() => {\n                        worker.sendToMaster({type: 'event', subtype: 'nuxtBuilt', message: 'nuxt has been built'})\n                        resolve('true')\n                    })\n                }\n            }).catch((e) => {\n                worker.sendToMaster({type: 'error', subtype: 'builders', 'e':e, message: e.message})\n                reject(e)\n            })\n        }\n        else {\n            resolve(true)\n        }\n\n    })\n\n    builderPromise.then(() => {\n\n        // Give nuxt middleware to express\n        app.use(nuxt.render)\n\n        // Add GET /health-check express route\n        healthChecker.attach(worker, app)\n        httpServer.on('request', app)\n\n        var count = 0\n\n        let vuxtraServer = new VuxtraServer(config.vuxtra)\n\n        // lets register current socket with vuxtraServer\n        vuxtraServer.registerSocketServer(scServer)\n        // lets run it\n        vuxtraServer.run()\n\n        worker.sendToMaster({type: 'event', subtype: 'vuxtraStarted', message: 'vuxtra has started'})\n\n    })\n\n}\n"],"names":["Controller","Tapable","_options","_socket","options","socket","ServiceController","data","res","request","ServiceRequest","response","ServiceResponse","setId","getId","ssSuccess","setServiceName","getServiceName","setServiceAction","getServiceAction","type","getType","ssClientErrorInvalidRequest","absoluteServicePath","join","buildDir","service","require","resolve","default","ssClientErrorNotFound","ctx","Promise","apply","_","values","getData","then","result","setData","e","code","ssServerError","message","VuxtraServer","hooks","AsyncParallelHook","socketServer","serviceController","hasIn","Error","init","promise","on","socketConnection","processServiceRequest","interval","setInterval","emit","Math","floor","random","ready","process","sep","vuxtraServerConfig","entryFiles","nodeModulesDir","__dirname","env","value","key","indexOf","JSON","stringify","outputPath","log","config","Infinity","srcDir","rootDir","modulesDir","Object","assign","babelOptions","build","plugins","concat","webpack","DefinePlugin","push","compiler","plugin","stats","compilation","warnings","filter","warn","name","includes","moduleDirs","forEach","dir","existsSync","externals","nodeExternals","dev","LoaderOptionsPlugin","cloneDeep","debug","Debug","color","VuxtraBuilder","defaults","babel","babelrc","presets","fs","setupBuildDir","buildWebpack","built","remove","r","mkdirp","serviceObj","filePath","path","pathSections","trim","split","entryFileObj","remoteObj","trimEnd","forIn","set","replace","slice","templateFn","template","fileContent","readFile","exval","Exval","content","model","clientPathJs","writeFile","resetFolders","compilersOptions","glob","sync","reduce","entries","entry","isEmpty","vuxtraCompilerConfig","vuxtraServerWebpackConfig","call","compilers","args","sharedFS","sharedCache","compilersOption","outputFileSystem","cache","hasErrors","pluginDone","compile","sequence","reject","watch","watchers","err","run","console","error","toString","webpackStats","generateFiles","compileDone","patterns","chokidar","refreshWebpack","debounce","refreshWebpackReset","filesWatcher","module","exports","worker","pid","environment","app","express","httpServer","scServer","reason","p","sendToMaster","subtype","use","morgan","__full_deep_temp_options","isArray","nuxt","modules","templates","Nuxt","builderPromise","vuxtra","vuxtraBuilder","watchDev","nuxtBuilder","NuxtBuilder","catch","render","attach","vuxtraServer","registerSocketServer"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEe,MAAMA,UAAN,SAAyBC,OAAzB,CAAiC;gBAC/BC,QAAb,EAAuBC,OAAvB,EAAgC;;aAEvBC,OAAL,GAAkBF,QAAlB;aACKG,MAAL,GAAkBF,OAAlB;;;;;ACAO,MAAMG,iBAAN,SAAgCN,UAAhC,CAA2C;gBACzCE,QAAb,EAAuB;cACbA,QAAN;;;YAGKK,IAAT,EAAeC,GAAf,EAAoB;YACZC,UAAU,IAAIC,yBAAJ,CAAmBH,IAAnB,CAAd;;YAEII,WAAW,IAAIC,0BAAJ,EAAf;iBACSC,KAAT,CAAeJ,QAAQK,KAAR,EAAf;iBACSC,SAAT;iBACSC,cAAT,CAAwBP,QAAQQ,cAAR,EAAxB;iBACSC,gBAAT,CAA0BT,QAAQU,gBAAR,EAA1B;;YAEIC,OAAOX,QAAQY,OAAR,EAAX;;YAEID,SAAS,IAAT,IAAiBA,SAAS,SAA1B,IAAuCX,QAAQQ,cAAR,OAA6B,IAAxE,EAA8E;qBACjEK,2BAAT;gBACI,IAAJ,EAAUX,QAAV;;;;YAIAY,sBAAuBC,UAAK,KAAKpB,OAAL,CAAaqB,QAAlB,EAA4B,QAA5B,EAAsChB,QAAQQ,cAAR,KAA2B,KAAjE,CAA3B;;YAEI;gBACIS,UAAUC,QAAQC,aAAQL,mBAAR,CAAR,EAAsCM,OAApD;;gBAEI,OAAOH,QAAQjB,QAAQU,gBAAR,EAAR,CAAP,KAA+C,WAA/C,IAA8DO,QAAQjB,QAAQU,gBAAR,EAAR,MAAwC,IAA1G,EAAgH;yBACnGW,qBAAT,CAAgC,WAAUrB,QAAQQ,cAAR,EAAyB,4BAA2BR,QAAQU,gBAAR,EAA2B,EAAzH;oBACI,IAAJ,EAAUR,QAAV;;;;gBAIAoB,MAAM,EAACtB,OAAD,EAAUE;;;aAApB,CAGAqB,QAAQJ,OAAR,CAAgBF,QAAQjB,QAAQU,gBAAR,EAAR,EAAoCc,KAApC,CAA0CF,GAA1C,EAA+CG,WAAEC,MAAF,CAAS1B,QAAQ2B,OAAR,EAAT,CAA/C,CAAhB,EAA6FC,IAA7F,CAAkGC,UAAU;yBAC/FC,OAAT,CAAiBD,MAAjB;oBACI,IAAJ,EAAU3B,QAAV;aAFJ;SAZJ,CAiBE,OAAO6B,CAAP,EAAU;gBACJA,EAAEC,IAAF,KAAW,kBAAf,EAAmC;yBACtBX,qBAAT,CAAgC,gBAAerB,QAAQQ,cAAR,EAAyB,YAAxE;oBACI,IAAJ,EAAUN,QAAV;;;qBAGK+B,aAAT,CAAuBF,EAAEG,OAAzB;gBACI,IAAJ,EAAUhC,QAAV;;;;;;;ACjDG,MAAMiC,YAAN,SAA2B3C,OAA3B,CAAmC;gBACjCG,OAAb,EAAsB;;;aAGbyC,KAAL,GAAa;kBACH,IAAIC,iBAAJ,CAAsB,CAAC,cAAD,CAAtB,CADG;mBAEF,IAAIA,iBAAJ,CAAsB,CAAC,cAAD,CAAtB,CAFE;8BAGS,IAAIA,iBAAJ,CAAsB,CAAC,QAAD,CAAtB;SAHtB;aAKK1C,OAAL,GAAeA,OAAf;aACK2C,YAAL,GAAoB,IAApB;aACKC,iBAAL,GAAyB,IAAzB;;;yBAIiBD,YAArB,EAAmC;;;YAG3B,CAACb,WAAEe,KAAF,CAAQF,YAAR,EAAsB,CACnB,UADmB,EAEnB,IAFmB,CAAtB,CAAL,EAGI;kBACMG,MAAM,4EAAN,CAAN;;aAECH,YAAL,GAAoBA,YAApB;;;UAGE;aACGF,KAAL,CAAWM,IAAX,CAAgBC,OAAhB,CAAwB,IAAxB;YACI,KAAKL,YAAL,KAAsB,IAA1B,EAAgC;kBACtBG,MAAM,6EAAN,CAAN;;;aAGCH,YAAL,CAAkBM,EAAlB,CAAqB,YAArB,EAAqChD,MAAD,IAAY;;iBAEvCwC,KAAL,CAAWS,gBAAX,CAA4BF,OAA5B,CAAoC/C,MAApC;;iBAEKkD,qBAAL,CAA2BlD,MAA3B;;gBAEImD,WAAWC,YAAY,YAAY;uBAC5BC,IAAP,CAAY,MAAZ,EAAoB;0BACVC,KAAKC,KAAL,CAAWD,KAAKE,MAAL,KAAgB,CAA3B;iBADV;aADW,EAIZ,IAJY,CAAf;;mBAMOR,EAAP,CAAU,YAAV,EAAwB,YAAY;8BAClBG,QAAd;aADJ;SAZJ;;aAiBKX,KAAL,CAAWiB,KAAX,CAAiBV,OAAjB,CAAyB,IAAzB;;;0BAGkB/C,MAAtB,EAA8B;;eAEnBgD,EAAP,CAAU,cAAV,EAA0B,CAAC9C,IAAD,EAAOC,GAAP,KAAe;gBACjC,KAAKwC,iBAAL,KAA2B,IAA/B,EAAqC;qBAC5BA,iBAAL,GAAyB,IAAI1C,iBAAJ,CAAsB,KAAKF,OAA3B,EAAoCC,MAApC,CAAzB;;;iBAGC2C,iBAAL,CAAuBe,OAAvB,CAA+BxD,IAA/B,EAAqCC,GAArC;SALJ;;;;ACCD,SAAS,QAAQ,EAAE,KAAK,EAAE,EAAE,EAAE;EACnC,OAAO,KAAK,CAAC,MAAM,CAAC,CAAC,OAAO,EAAE,IAAI,KAAK,OAAO,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,CAAC,EAAE,OAAO,CAAC,OAAO,EAAE,CAAC;CACxF;;AAED,AAEC;;AAED,AAqBC;;AAED,AAEC;;AAED,AAAO,MAAM,SAAS,GAAG,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAC;;AAEtD,AAAO,SAAS,EAAE,EAAE,CAAC,GAAG,EAAE,EAAE;;EAE1B,IAAI,SAAS,EAAE;IACb,OAAO,CAAC,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC;GAChC;EACD,OAAO,CAAC;CACT;;AAED,AAMC;;AAED,MAAM,MAAM,GAAG,MAAK;AACpB,MAAM,MAAM,GAAG0B,UAAC,CAAC,YAAY,CAAC8B,QAAG,EAAC;AAClC,MAAM,SAAS,GAAG,MAAM,IAAI,MAAM,CAAC,OAAO,CAAC,MAAM,EAAE,MAAM,EAAC;;AAE1D,AAAO,SAAS,CAAC,IAAI;EACnB,IAAI,IAAI,GAAG,KAAK,CAAC,SAAS,CAAC,KAAK,CAAC,KAAK,CAAC,SAAS,EAAC;EACjD,IAAI,OAAO,GAAG9B,UAAC,CAAC,IAAI,CAAC,IAAI,EAAC;;EAE1B,IAAI,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;IAClD,OAAO,EAAE,CAAC,OAAO,CAAC;GACnB;;EAED,OAAO,EAAE,CAACN,YAAO,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC;CAC3C;;ACxHc,SAASqC,kBAAT,CAA6BC,UAA7B,EAAyC;UAC9CC,iBAAiB3C,UAAK4C,SAAL,EAAgB,IAAhB,EAAsB,cAAtB,CAAvB;;QAEIC,MAAM;eACC;KADX;WAGK,KAAKjE,OAAL,CAAaiE,GAAlB,EAAuB,CAACC,KAAD,EAAQC,GAAR,KAAgB;YAC/B,iBAAiBA,GAArB,IAA6B,CAAC,SAAD,EAAY,QAAZ,EAAsBC,OAAtB,CAA8B,OAAOF,KAArC,MAAgD,CAAC,CAAjD,GAAqDA,KAArD,GAA6DG,KAAKC,SAAL,CAAeJ,KAAf,CAA1F;KADJ;;QAIEK,aAAa/C,aAAQ,KAAKxB,OAAL,CAAaqB,QAArB,EAA+B,QAA/B,CAAjB;;YAEUmD,GAAR;;UAEMC,SAAS;cACL,eADK;gBAEH,MAFG;cAGL,KAHK;iBAIF,YAJE;eAKJX,UALI;gBAMH;kBACES,UADF;sBAEM,WAFN;2BAGW,uBAHX;2BAIW;SAVR;qBAYE;+BACU,OADV;mBAEF,KAFE;0BAGKG;SAfP;iBAiBF;wBACO,CAAC,KAAD,EAAQ,OAAR,EAAiB,KAAjB,CADP;mBAEE;qBACEtD,UAAK,KAAKpB,OAAL,CAAa2E,MAAlB,CADF;sBAEGvD,UAAK,KAAKpB,OAAL,CAAa4E,OAAlB,CAFH;qBAGExD,UAAK,KAAKpB,OAAL,CAAa2E,MAAlB,CAHF;sBAIGvD,UAAK,KAAKpB,OAAL,CAAa4E,OAAlB;aANL;qBAQI,CACL,KAAK5E,OAAL,CAAa6E,UADR,EAELd,cAFK;SAzBF;uBA8BI;qBACF,CACL,KAAK/D,OAAL,CAAa6E,UADR,EAELd,cAFK;SA/BF;gBAoCH;qBACK,kBADL;mBAEG,CACH;sBACU,OADV;wBAEY,cAFZ;yBAGa,cAHb;yBAIae,OAAOC,MAAP,CAAc,EAAd,EAAkB,KAAKC,YAAvB;aALV;SAtCA;mBA+CA,EA/CA;iBAgDF,CAAC,KAAKhF,OAAL,CAAaiF,KAAb,CAAmBC,OAAnB,IAA8B,EAA/B,EAAmCC,MAAnC,CAA0C,CAC/C,IAAIC,QAAQC,YAAZ,CAAyBP,OAAOC,MAAP,CAAcd,GAAd,EAAmB;mBACjC;SADc,CAAzB,CAD+C,CAA1C;;;KAhDb,CAwDAQ,OAAOS,OAAP,CAAeI,IAAf,CAAoB;cACTC,QAAP,EAAiB;qBACJC,MAAT,CAAgB,MAAhB,EAAwBC,SAAS;sBACvBC,WAAN,CAAkBC,QAAlB,GAA6BF,MAAMC,WAAN,CAAkBC,QAAlB,CAA2BC,MAA3B,CAAkCC,QAAQ;wBAC/DA,KAAKC,IAAL,KAAc,yBAAd,IAA2CD,KAAKtD,OAAL,CAAawD,OAAb,CAAuB,kBAAvB,CAA3C,WAAwFF,KAAKtD,OAAL,CAAawD,OAAb,CAAsB,QAAtB,CAAxF,OAAJ,EAA6H;+BAClH,KAAP;;2BAEG,IAAP;iBAJyB,CAA7B;aADJ;;KAFR;;;;UAeMC,aAAa,CACf,KAAKhG,OAAL,CAAa6E;;;KADjB;eAKWoB,OAAX,CAAmBC,OAAO;YAClBC,gBAAWD,GAAX,CAAJ,EAAqB;mBACVE,SAAP,CAAiBd,IAAjB,CAAsBe,cAAc;;2BAErB,CAAC,wCAAD,CAFqB;4BAGpBH;aAHM,CAAtB;;KAFR;;;;;QAoBI,CAAC,KAAKlG,OAAL,CAAasG,GAAlB,EAAuB;eACZpB,OAAP,CAAeI,IAAf,CACI,IAAIF,QAAQmB,mBAAZ,CAAgC;sBAClB;SADd,CADJ;;;;WAQGC,YAAU/B,MAAV,CAAP;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrHJ;AACA,AAIA,MAAMgC,UAAQC,MAAM,cAAN,CAAd;AACAD,QAAME,KAAN,GAAc,CAAd;;AAEA,AAEe,MAAMC,aAAN,SAA4B/G,OAA5B,CAAoC;gBAClCC,QAAb,EAAuB;;;;aAId2C,KAAL,GAAa;kBACH,IAAIC,iBAAJ,CAAsB,CAAC,SAAD,CAAtB,CADG;mBAEF,IAAIA,iBAAJ,CAAsB,CAAC,SAAD,CAAtB,CAFE;qBAGA,IAAIA,iBAAJ,CAAsB,CAAC,UAAD,CAAtB,CAHA;wBAIG,IAAIA,iBAAJ,CAAsB,CAAC,UAAD,CAAtB,CAJH;yBAKI,IAAIA,iBAAJ,CAAsB,CAAC,UAAD,CAAtB;SALjB;;aAQK1C,OAAL,GAAkBF,QAAlB;aACKyF,QAAL,GAAkB,IAAlB;;;SAGJ,GAAc;;;;oBACJ,0BAAN;kBACM,MAAK9C,KAAL,CAAWM,IAAX,CAAgBC,OAAhB,OAAN;;;kBAGKgC,YAAL,GAAoBlD,WAAE+E,QAAF,CAAW,MAAK7G,OAAL,CAAaiF,KAAb,CAAmB6B,KAA9B,EAAqC;yBAC5C,KAD4C;gCAErC,CAAC,CAAC,MAAK9G,OAAL,CAAasG;aAFf,CAApB;gBAII,CAAC,MAAKtB,YAAL,CAAkB+B,OAAnB,IAA8B,CAAC,MAAK/B,YAAL,CAAkBgC,OAArD,EAA8D;sBACrDhC,YAAL,CAAkBgC,OAAlB,GAA4B,CACxBzF,QAAQC,OAAR,CAAgB,sBAAhB,CADwB,CAA5B;;;;gBAMA,CAACyF,YAAGd,UAAH,CAAc/E,UAAK,MAAKpB,OAAL,CAAa2E,MAAlB,EAA0B,QAA1B,CAAd,CAAL,EAAyD;oBACjDuB,MAAM,MAAKlG,OAAL,CAAa2E,MAAvB;oBACIsC,YAAGd,UAAH,CAAc3E,aAAQ,MAAKxB,OAAL,CAAa2E,MAArB,EAA6B,IAA7B,EAAmC,QAAnC,CAAd,CAAJ,EAAiE;0BACvD,IAAI7B,KAAJ,CAAW,oCAAmCoD,GAAI,qEAAlD,CAAN;iBADJ,MAEO;0BACG,IAAIpD,KAAJ,CAAW,2CAA0CoD,GAAI,4CAAzD,CAAN;;;;;;;oBAOD,aAAY,MAAKlG,OAAL,CAAa2E,MAAO,EAAvC;oBACO,cAAa,MAAK3E,OAAL,CAAaqB,QAAS,WAA1C;;kBAEM,MAAK6F,aAAL,EAAN;kBACM,MAAKC,YAAL,EAAN;;kBAEM,MAAK1E,KAAL,CAAW2E,KAAX,CAAiBpE,OAAjB,OAAN;;;;iBAIJ,GAAsB;;;;;kBAEZqE,UAAOC,EAAE,OAAKtH,OAAL,CAAaqB,QAAf,CAAP,CAAN;kBACMkG,UAAOD,EAAE,OAAKtH,OAAL,CAAaqB,QAAf,EAAyB,QAAzB,CAAP,CAAN;gBACI,CAAC,OAAKrB,OAAL,CAAasG,GAAlB,EAAuB;sBACbiB,UAAOD,EAAE,OAAKtH,OAAL,CAAaqB,QAAf,EAAyB,MAAzB,CAAP,CAAN;;;;;iBAKR,CAAqByC,UAArB,EAAiC;;;;gBACzB0D,aAAa,EAAjB;uBACEvB,OAAF,CAAUnC,UAAV,EAAsB,UAAC2D,QAAD,EAAWC,OAAX,EAAoB;;oBAElCC,eAAe7F,WAAE8F,IAAF,CAAOF,OAAP,EAAa,GAAb,EAAkBG,KAAlB,CAAwB,GAAxB,CAAnB;;wBAEQF,aAAa,CAAb,CAAR;yBACS,UAAL;;;4BAGQG,eAAe,EAAnB;4BACIC,YAAYxG,QAAQH,UAAK,OAAKpB,OAAL,CAAaqB,QAAlB,EAA4B,QAA5B,EAAsCS,WAAEkG,OAAF,CAAUN,OAAV,EAAe,GAAf,IAAoB,KAA1D,CAAR,EAA0EjG,OAA1F;mCACEwG,KAAF,CAAQF,SAAR,EAAmB,UAAC7D,KAAD,EAAOC,GAAP,EAAe;yCACjBA,GAAb,IAAoBuD,OAApB;yBADJ;;;;;;mCAQEQ,GAAF,CAAMV,UAAN,EAAkB1F,WAAEqG,OAAF,CAAUrG,WAAE8F,IAAF,CAAOxG,UAAKS,KAAL,CAAW,IAAX,EAAiB8F,aAAaS,KAAb,CAAmB,CAAnB,CAAjB,CAAP,EAAgD,GAAhD,CAAV,EAAgE,KAAhE,EAAuE,GAAvE,CAAlB,EAA+FN,YAA/F;;;;aAlBZ;;gBAyBIO,aAAavG,WAAEwG,QAAF,CAAY;;kCAAZ,CAAjB;;kBAIMC,cAAc,MAAMC,YAASpH,UAAK4C,SAAL,EAAgB,oCAAhB,CAAT,EAAgE,MAAhE,CAA1B;kBACMsE,WAAWxG,WAAEwG,QAAF,CAAWC,WAAX,CAAjB;;gBAEIE,QAAQ,IAAIC,KAAJ,EAAZ;;kBAEMC,UAAUL,SAAS;4BACTD,WAAW,EAAEO,OAAOpB,UAAT,EAAqBa,YAAYA,UAAjC,EAAX;aADA,CAAhB;;gBAIIQ,eAAevB,EAAE,OAAKtH,OAAL,CAAaqB,QAAf,EAAyB,iBAAzB,CAAnB;kBACMyH,aAAUD,YAAV,EAAwBF,OAAxB,EAAiC,MAAjC,CAAN;;;;gBAIJ,CAAoBI,eAAe,KAAnC,EAA0C;;;;oBAChC,mBAAN;oBACQvE,GAAR,CAAY,2BAAZ;kBACMwE,mBAAmB,EAAzB;;gBAEID,YAAJ,EAAkB;sBACR,OAAK7B,aAAL,EAAN;;;gBAGApD,aAAamF,KAAKC,IAAL,CAAW,GAAE,OAAKlJ,OAAL,CAAa2E,MAAO,8CAAjC,EAAgFwE,MAAhF,CAAuF,UAACC,OAAD,EAAUC,KAAV;uBAAoBvE,OAAOC,MAAP,CAAcqE,OAAd,EAAuB,EAAC,CAACC,MAAMlB,OAAN,CAAc,OAAKnI,OAAL,CAAa2E,MAAb,GAAoB,SAAlC,EAA6C,EAA7C,EAAiDwD,OAAjD,CAAyD,KAAzD,EAAgE,EAAhE,CAAD,GAAuEkB,KAAxE,EAAvB,CAApB;aAAvF,EAAmN,EAAnN,CAAjB;;gBAEI,CAACvH,WAAEwH,OAAF,CAAUxF,UAAV,CAAL,EAA4B;;sBAElByF,uBAAuBC,mBAA0BC,IAA1B,SAAqC3F,UAArC,CAA7B;iCACiBwB,IAAjB,CAAsBiE,oBAAtB;;;;;mBAMChE,QAAL,GAAgB,EAAEmE,WAAW,EAAb,EAAhB;mBACKnE,QAAL,CAAcC,MAAd,GAAuB,UAAC,GAAGmE,IAAJ,EAAa;uBAC3BpE,QAAL,CAAcmE,SAAd,CAAwBzD,OAAxB,CAAgC,oBAAY;6BAC/BT,MAAT,CAAgB,GAAGmE,IAAnB;iBADJ;aADJ;;;;kBAQMC,WAAW,KAAjB,CA7BsC;kBA8BhCC,cAAc,EAApB;;;6BAGiB5D,OAAjB,CAAyB,2BAAmB;sBAClCV,WAAWH,QAAQ0E,eAAR,CAAjB;oBACIF,YAAY,EAACrE,SAASO,IAAT,CAAcC,OAAd,CAAuB,MAAvB,CAAD,QAAhB,EAAiD;6BACpCgE,gBAAT,GAA4BH,QAA5B;;yBAEKI,KAAT,GAAiBH,WAAjB;uBACKtE,QAAL,CAAcmE,SAAd,CAAwBpE,IAAxB,CAA6BC,QAA7B;aANJ;;;mBAUKA,QAAL,CAAcmE,SAAd,CAAwBzD,OAAxB,CAAgC,oBAAY;oBACpCV,SAASO,IAAb,EAAmB;2BACVP,QAAL,CAAcA,SAASO,IAAvB,IAA+BP,QAA/B;;aAFR;;;mBAOKA,QAAL,CAAcC,MAAd,CAAqB,MAArB;4CAA6B,WAAMC,KAAN,EAAe;;wBAEpCA,MAAMwE,SAAN,EAAJ,EAAuB;;;;;;0BAMjB,OAAKxH,KAAL,CAAWyH,UAAX,CAAsBlH,OAAtB,QAAN;iBARJ;;;;;;;kBAWM,OAAKP,KAAL,CAAW0H,OAAX,CAAmBnH,OAAnB,QAAN;;;kBAGMoH,SAAS,OAAK7E,QAAL,CAAcmE,SAAvB,EAAkC;uBAAY,IAAI9H,OAAJ,CAAY,UAACJ,UAAD,EAAU6I,MAAV,EAAqB;wBAC7E,OAAKrK,OAAL,CAAasG,GAAjB,EAAsB;;;iCAGTgE,KAAT,CAAe,OAAKtK,OAAL,CAAauK,QAAb,CAAsBnF,OAArC,EAA8C,UAACoF,GAAD,EAAS;gCAC/CA,GAAJ,EAAS;uCACEH,OAAOG,GAAP,CAAP;;;yBAFR;qBAHJ,MAUO;;iCAEMC,GAAT,CAAa,UAACD,GAAD,EAAM/E,KAAN,EAAgB;gCACrB+E,GAAJ,EAAS;uCACEH,OAAOG,GAAP,CAAP;;gCAEAA,GAAJ,EAAS,OAAOE,QAAQC,KAAR,CAAcH,GAAd,CAAP,CAJgB;;;oCAOjBhG,GAAR,CAAYiB,MAAMmF,QAAN,CAAe,OAAKC,YAApB,CAAZ,EAPyB;;gCASrBpF,MAAMwE,SAAN,EAAJ,EAAuB;uCACZI,OAAO,IAAIvH,KAAJ,CAAU,kCAAV,CAAP,CAAP;;;yBAVR;;iBAb4C,CAAZ;aAAlC,CAAN;;kBA+BM,OAAKgI,aAAL,CAAmBhH,UAAnB,CAAN;;kBAEM,OAAKrB,KAAL,CAAWsI,WAAX,CAAuB/H,OAAvB,QAAN;;;;eAIO;cACDgI,WAAW,CACb1D,EAAE,KAAKtH,OAAL,CAAa2E,MAAf,EAAuB,sBAAvB,CADa,CAAjB;cAGM3E,UAAU8E,OAAOC,MAAP,CAAc,EAAd,EAAkB,KAAK/E,OAAL,CAAauK,QAAb,CAAsBU,QAAxC,EAAkD;2BAC/C;SADH,CAAhB;cAGMC,iBAAiBpJ,WAAEqJ,QAAF,CAAW,MAAM;oBACxB3G,GAAR,CAAY,uBAAZ;iBACK2C,YAAL;SAFe,EAIjB,IAJiB,CAAvB;;cAOMiE,sBAAsBtJ,WAAEqJ,QAAF,CAAW,MAAM;iBAChChE,YAAL,CAAkB,IAAlB;SADoB,EAGtB,IAHsB,CAA5B;;;YAOIkE,eAAeJ,SAASX,KAAT,CAAeU,QAAf,EAAyBhL,OAAzB,EACdiD,EADc,CACX,KADW,EACJiI,cADI,EAEdjI,EAFc,CAEX,QAFW,EAEDmI,mBAFC,EAGdnI,EAHc,CAGX,QAHW,EAGDiI,cAHC,CAAnB;;;;AChPR,MAAMzE,QAAQC,MAAM,aAAN,CAAd;AACAD,MAAME,KAAN,GAAc,CAAd;;AAGA2E,OAAOC,OAAP,CAAed,GAAf,GAAqB,UAAUe,MAAV,EAAkB;UAC7B,mBAAN,EAA2B7H,QAAQ8H,GAAnC;QACIC,cAAcF,OAAOxL,OAAP,CAAe0L,WAAjC;;QAEIC,MAAMC,SAAV;;QAEIC,aAAaL,OAAOK,UAAxB;QACIC,WAAWN,OAAOM,QAAtB;;YAEQ7I,EAAR,CAAW,oBAAX,EAAiC,CAAC8I,MAAD,EAASC,CAAT,KAAe;;eAErCC,YAAP,CAAoB,EAACjL,MAAM,OAAP,EAAgBkL,SAAS,QAAzB,EAAmC9J,GAAE4J,CAArC,EAAwCzJ,SAASwJ,MAAjD,EAApB;KAFJ;;QAKIL,eAAe,KAAnB,EAA0B;;;YAGlBS,GAAJ,CAAQC,OAAO,KAAP,CAAR;;;;QAIA3H,SAAS+G,OAAOxL,OAAP,CAAeqM,wBAA5B;;QAEI,CAACvK,WAAEwK,OAAF,CAAU7H,OAAO8H,IAAP,CAAYC,OAAtB,CAAL,EAAqC;eAC1BD,IAAP,CAAYC,OAAZ,GAAsB,EAAtB;;;;WAIGD,IAAP,CAAYC,OAAZ,CAAoBlH,IAApB,CACI;aACU,sCADV;iBAEab;KAHjB;;QAMI,CAAC3C,WAAEwK,OAAF,CAAU7H,OAAO8H,IAAP,CAAYtH,KAAtB,CAAL,EAAmC;eACxBsH,IAAP,CAAYtH,KAAZ,GAAoB,EAApB;;YAEI,CAACnD,WAAEwK,OAAF,CAAU7H,OAAO8H,IAAP,CAAYtH,KAAZ,CAAkBwH,SAA5B,CAAL,EAA6C;mBAClCF,IAAP,CAAYtH,KAAZ,CAAkBwH,SAAlB,GAA8B,EAA9B;;;;WAIDF,IAAP,CAAYtH,KAAZ,CAAkBwH,SAAlB,CAA4BnH,IAA5B,CAAiC,2BAAjC;;;UAGMiH,UAAO,IAAIG,SAAJ,CAASjI,OAAO8H,IAAhB,CAAb;;QAEII,iBAAiB,IAAI/K,OAAJ,CAAY,CAACJ,UAAD,EAAU6I,MAAV,KAAqB;;;YAG9C5F,OAAOmI,MAAP,CAActG,GAAlB,EAAuB;kBACbuG,gBAAgB,IAAIjG,aAAJ,CAAkBnC,OAAOmI,MAAzB,CAAtB;0BACc3H,KAAd,GAAsBhD,IAAtB,CAA2B,MAAM;uBACtBgK,YAAP,CAAoB,EAACjL,MAAM,OAAP,EAAgBkL,SAAS,aAAzB,EAAwC3J,SAAS,uBAAjD,EAApB;8BACcuK,QAAd;;oBAEIrI,OAAO8H,IAAP,CAAYjG,GAAhB,EAAqB;0BACXyG,cAAc,IAAIC,YAAJ,CAAgBT,OAAhB,CAApB;gCACYtH,KAAZ,GAAoBhD,IAApB,CAAyB,MAAM;+BACpBgK,YAAP,CAAoB,EAACjL,MAAM,OAAP,EAAgBkL,SAAS,WAAzB,EAAsC3J,SAAS,qBAA/C,EAApB;mCACQ,MAAR;qBAFJ;;aANR,EAWG0K,KAXH,CAWU7K,CAAD,IAAO;uBACL6J,YAAP,CAAoB,EAACjL,MAAM,OAAP,EAAgBkL,SAAS,UAAzB,EAAqC,KAAI9J,CAAzC,EAA4CG,SAASH,EAAEG,OAAvD,EAApB;uBACOH,CAAP;aAbJ;SAFJ,MAkBK;uBACO,IAAR;;KAtBa,CAArB;;mBA2BeH,IAAf,CAAoB,MAAM;;;YAGlBkK,GAAJ,CAAQI,QAAKW,MAAb;;;sBAGcC,MAAd,CAAqB3B,MAArB,EAA6BG,GAA7B;mBACW1I,EAAX,CAAc,SAAd,EAAyB0I,GAAzB;;YAIIyB,eAAe,IAAI5K,YAAJ,CAAiBiC,OAAOmI,MAAxB,CAAnB;;;qBAGaS,oBAAb,CAAkCvB,QAAlC;;qBAEarB,GAAb;;eAEOwB,YAAP,CAAoB,EAACjL,MAAM,OAAP,EAAgBkL,SAAS,eAAzB,EAA0C3J,SAAS,oBAAnD,EAApB;KAlBJ;CA1EJ"}