{"version":3,"file":"sccWorker.js","sources":["../lib/vuxtraserver/controllers/controller.js","../lib/vuxtraserver/controllers/serviceController.js","../lib/vuxtraserver/context/authToken.js","../node_modules/uuid/lib/rng.js","../node_modules/uuid/lib/bytesToUuid.js","../node_modules/uuid/v4.js","../lib/vuxtraserver/context/session.js","../lib/vuxtraserver/vuxtraServer.js","../node_modules/nuxt/lib/common/utils.js","../lib/builder/webpack/vuxtraServer.config.js","../lib/builder/index.js","../lib/socketserver/sccWorker.js"],"sourcesContent":["import Tapable from 'tapable'\n\nexport default class Controller extends Tapable {\n    constructor (_options, _session) {\n        super()\n        this.options    = _options\n        this.session     = _session\n    }\n\n }","import Controller from './controller'\nimport { ServiceRequest } from '@vuxtra/shared-core'\nimport { ServiceResponse } from '@vuxtra/shared-core'\nimport { join, resolve, basename, dirname } from 'path'\nimport _ from 'lodash'\n\nexport default class ServiceController extends Controller {\n    constructor (_options, session) {\n        super(_options, session)\n    }\n\n    process (data, res) {\n        let request = new ServiceRequest(data)\n\n        let response = new ServiceResponse()\n        response.setId(request.getId())\n        response.ssSuccess()\n        response.setServiceName(request.getServiceName())\n        response.setServiceAction(request.getServiceAction())\n\n        let type = request.getType()\n\n        if (type === null || type !== 'service' || request.getServiceName() === null) {\n            response.ssClientErrorInvalidRequest()\n            res(null, response)\n            return\n        }\n\n        let absoluteServicePath =  join(this.options.buildDir, 'server', request.getServiceName() + '.js')\n\n        try {\n            let service = require(resolve(absoluteServicePath)).default\n\n            if (typeof service[request.getServiceAction()] === 'undefined' || service[request.getServiceAction()] === null) {\n                response.ssClientErrorNotFound(`service ${request.getServiceName()} does not contain action ${request.getServiceAction()}`)\n                res(null, response)\n                return\n            }\n\n            let ctx = { '$request': request, '$response': response, '$session': this.session}\n\n            // here we process it weather is sync or async\n            Promise.resolve(service[request.getServiceAction()].apply(ctx, _.values(request.getData()))).then(result => {\n                response.setData(result)\n                res(null, response)\n            });\n\n        } catch (e) {\n            if (e.code === 'MODULE_NOT_FOUND') {\n                response.ssClientErrorNotFound(`service name ${request.getServiceName()} not found`)\n                res(null, response)\n                return\n            }\n            response.ssServerError(e.message)\n            res(null, response)\n            return\n        }\n    }\n\n}","export default class AuthToken {\n    constructor (rawToken = {}) {\n        if (rawToken === null) {\n            rawToken = {}\n        }\n        this.v = (typeof rawToken.v !== 'undefined' ? rawToken.v : 0)\n        this.uid = (typeof rawToken.uid !== 'undefined' ? rawToken.uid : null)\n        this.sid = (typeof rawToken.sid !== 'undefined' ? rawToken.sid : null)\n        this.ct = (typeof rawToken.ct !== 'undefined' ? rawToken.ct : null)\n    }\n\n    // setters\n    setUserId (data) {\n        this.v++\n        this.uid = data\n        return this\n    }\n\n    setSessionId (data) {\n        this.v++\n        this.sid = data\n        return this\n    }\n\n    setCreatedTime (data) {\n        this.v++\n        this.ct = data\n        return this\n    }\n\n    // getters\n    getUserId () {\n        return  this.uid\n    }\n\n    getSessionId () {\n        return this.sid\n    }\n\n    getCreatedTime () {\n        return this.ct\n    }\n\n}","// Unique ID creation requires a high quality random # generator.  In node.js\n// this is pretty straight-forward - we use the crypto API.\n\nvar rb = require('crypto').randomBytes;\n\nfunction rng() {\n  return rb(16);\n}\n\nmodule.exports = rng;\n","/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\nvar byteToHex = [];\nfor (var i = 0; i < 256; ++i) {\n  byteToHex[i] = (i + 0x100).toString(16).substr(1);\n}\n\nfunction bytesToUuid(buf, offset) {\n  var i = offset || 0;\n  var bth = byteToHex;\n  return bth[buf[i++]] + bth[buf[i++]] +\n          bth[buf[i++]] + bth[buf[i++]] + '-' +\n          bth[buf[i++]] + bth[buf[i++]] + '-' +\n          bth[buf[i++]] + bth[buf[i++]] + '-' +\n          bth[buf[i++]] + bth[buf[i++]] + '-' +\n          bth[buf[i++]] + bth[buf[i++]] +\n          bth[buf[i++]] + bth[buf[i++]] +\n          bth[buf[i++]] + bth[buf[i++]];\n}\n\nmodule.exports = bytesToUuid;\n","var rng = require('./lib/rng');\nvar bytesToUuid = require('./lib/bytesToUuid');\n\nfunction v4(options, buf, offset) {\n  var i = buf && offset || 0;\n\n  if (typeof(options) == 'string') {\n    buf = options == 'binary' ? new Array(16) : null;\n    options = null;\n  }\n  options = options || {};\n\n  var rnds = options.random || (options.rng || rng)();\n\n  // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n  rnds[6] = (rnds[6] & 0x0f) | 0x40;\n  rnds[8] = (rnds[8] & 0x3f) | 0x80;\n\n  // Copy bytes to buffer, if provided\n  if (buf) {\n    for (var ii = 0; ii < 16; ++ii) {\n      buf[i + ii] = rnds[ii];\n    }\n  }\n\n  return buf || bytesToUuid(rnds);\n}\n\nmodule.exports = v4;\n","import AuthToken from './authToken'\nimport uuidv4  from 'uuid/v4'\n\nexport default class Session {\n    constructor (socket, authToken = null) {\n        this._socket = socket\n        if (authToken === null) {\n            console.log('authnull', this._socket.getAuthToken())\n            this.authToken = new AuthToken(this._socket.getAuthToken())\n            console.log('auththoken', this.authToken)\n            this.authToken.setSessionId(uuidv4())\n        } else {\n            this.authToken = authToken\n\n        }\n    }\n\n    generateUUID () {\n        return uuidv4()\n    }\n\n    authenticate (userUUID) {\n        this.authToken.setUserId(userUUID)\n        return this\n    }\n\n    isAuthenticated () {\n        return this.authToken.getUserId() !== null\n    }\n\n    isSession () {\n        return this.authToken.getSessionId() !== null\n    }\n\n    getSocket () {\n        return this._socket\n    }\n\n\n}","import Tapable from 'tapable'\nimport AsyncParallelHook from 'tapable/lib/AsyncParallelHook'\nimport _ from 'lodash'\nimport ServiceController from \"./controllers/serviceController\";\nimport Session from \"./context/session\";\n\nexport default class VuxtraServer extends Tapable {\n    constructor (options) {\n        super()\n        // setup available hooks\n        this.hooks = {\n            init: new AsyncParallelHook([\"vuxtraServer\"]),\n            ready: new AsyncParallelHook([\"vuxtraServer\"]),\n            socketConnection: new AsyncParallelHook([\"socket\"])\n        };\n        this.options = options\n        this.socketServer = null\n        this.serviceController = null\n\n    }\n\n    registerSocketServer(socketServer) {\n        // lets make sure proper interface is followed\n\n        if (!_.hasIn(socketServer, [\n                'exchange',\n                'on'\n        ])) {\n            throw Error('Not a valid socket server, make sure your object declares proper interface')\n        }\n        this.socketServer = socketServer\n    }\n\n    run() {\n        this.hooks.init.promise(this);\n        if (this.socketServer === null) {\n            throw Error('SocketServer should be setup and registered first with registerSocketServer')\n        }\n\n        this.socketServer.on('connection',  (socket) => {\n\n            this.hooks.socketConnection.promise(socket);\n\n            this.processServiceRequest(socket, new Session(socket))\n\n            socket.on('disconnect', function () {\n                // TO DO : do some graceful closing here\n            })\n        })\n\n        this.hooks.ready.promise(this);\n    }\n\n    processServiceRequest(socket, session) {\n        // set initial socket server auth token, we use it for session tracking\n        console.log('potential paylod', session.authToken)\n        socket.setAuthToken(session.authToken)\n\n        // process service calls\n        socket.on('service.call', (data, res) => {\n            if (this.serviceController === null) {\n                this.serviceController = new ServiceController(this.options, session)\n            }\n            let currentAuthTokenVersion = session.authToken.v\n            this.serviceController.process(data, res)\n            if (currentAuthTokenVersion !== session.authToken.v) {\n                // we record any changes to the authtoken during controller processing\n                socket.setAuthToken(session.authToken)\n            }\n\n        })\n    }\n}","import { resolve, relative, sep } from 'path'\nimport _ from 'lodash'\n\nexport function encodeHtml (str) {\n  return str.replace(/</g, '&lt;').replace(/>/g, '&gt;')\n}\n\nexport function getContext (req, res) {\n  return { req, res }\n}\n\nexport function setAnsiColors (ansiHTML) {\n  ansiHTML.setColors({\n    reset: ['efefef', 'a6004c'],\n    darkgrey: '5a012b',\n    yellow: 'ffab07',\n    green: 'aeefba',\n    magenta: 'ff84bf',\n    blue: '3505a0',\n    cyan: '56eaec',\n    red: '4e053a'\n  })\n}\n\nexport async function waitFor (ms) {\n  return new Promise(function (resolve) {\n    setTimeout(resolve, (ms || 0))\n  })\n}\n\nexport function urlJoin () {\n  return [].slice.call(arguments).join('/').replace(/\\/+/g, '/').replace(':/', '://')\n}\n\nexport function isUrl (url) {\n  return (url.indexOf('http') === 0 || url.indexOf('//') === 0)\n}\n\nexport function promisifyRoute (fn) {\n  // If routes is an array\n  if (Array.isArray(fn)) {\n    return Promise.resolve(fn)\n  }\n  // If routes is a function expecting a callback\n  if (fn.length === 1) {\n    return new Promise((resolve, reject) => {\n      fn(function (err, routeParams) {\n        if (err) {\n          reject(err)\n        }\n        resolve(routeParams)\n      })\n    })\n  }\n  let promise = fn()\n  if (!promise || (!(promise instanceof Promise) && (typeof promise.then !== 'function'))) {\n    promise = Promise.resolve(promise)\n  }\n  return promise\n}\n\nexport function sequence (tasks, fn) {\n  return tasks.reduce((promise, task) => promise.then(() => fn(task)), Promise.resolve())\n}\n\nexport function parallel (tasks, fn) {\n  return Promise.all(tasks.map(task => fn(task)))\n}\n\nexport function chainFn (base, fn) {\n  /* istanbul ignore if */\n  if (!(fn instanceof Function)) {\n    return\n  }\n  return function () {\n    if (typeof base !== 'function') {\n      return fn.apply(this, arguments)\n    }\n    let baseResult = base.apply(this, arguments)\n    // Allow function to mutate the first argument instead of returning the result\n    if (baseResult === undefined) {\n      baseResult = arguments[0]\n    }\n    let fnResult = fn.call(this, baseResult, ...Array.prototype.slice.call(arguments, 1))\n    // Return mutated argument if no result was returned\n    if (fnResult === undefined) {\n      return baseResult\n    }\n    return fnResult\n  }\n}\n\nexport function isPureObject (o) {\n  return !Array.isArray(o) && typeof o === 'object'\n}\n\nexport const isWindows = /^win/.test(process.platform)\n\nexport function wp (p = '') {\n  /* istanbul ignore if */\n  if (isWindows) {\n    return p.replace(/\\\\/g, '\\\\\\\\')\n  }\n  return p\n}\n\nexport function wChunk (p = '') {\n  /* istanbul ignore if */\n  if (isWindows) {\n    return p.replace(/\\//g, '\\\\\\\\')\n  }\n  return p\n}\n\nconst reqSep = /\\//g\nconst sysSep = _.escapeRegExp(sep)\nconst normalize = string => string.replace(reqSep, sysSep)\n\nexport function r () {\n  let args = Array.prototype.slice.apply(arguments)\n  let lastArg = _.last(args)\n\n  if (lastArg.includes('@') || lastArg.includes('~')) {\n    return wp(lastArg)\n  }\n\n  return wp(resolve(...args.map(normalize)))\n}\n\nexport function relativeTo () {\n  let args = Array.prototype.slice.apply(arguments)\n  let dir = args.shift()\n\n  // Resolve path\n  let path = r(...args)\n\n  // Check if path is an alias\n  if (path.includes('@') || path.includes('~')) {\n    return path\n  }\n\n  // Make correct relative path\n  let rp = relative(dir, path)\n  if (rp[0] !== '.') {\n    rp = './' + rp\n  }\n  return wp(rp)\n}\n\nexport function flatRoutes (router, path = '', routes = []) {\n  router.forEach((r) => {\n    if (!r.path.includes(':') && !r.path.includes('*')) {\n      /* istanbul ignore if */\n      if (r.children) {\n        flatRoutes(r.children, path + r.path + '/', routes)\n      } else {\n        routes.push((r.path === '' && path[path.length - 1] === '/' ? path.slice(0, -1) : path) + r.path)\n      }\n    }\n  })\n  return routes\n}\n\nexport function cleanChildrenRoutes (routes, isChild = false) {\n  let start = -1\n  let routesIndex = []\n  routes.forEach((route) => {\n    if (/-index$/.test(route.name) || route.name === 'index') {\n      // Save indexOf 'index' key in name\n      let res = route.name.split('-')\n      let s = res.indexOf('index')\n      start = (start === -1 || s < start) ? s : start\n      routesIndex.push(res)\n    }\n  })\n  routes.forEach((route) => {\n    route.path = (isChild) ? route.path.replace('/', '') : route.path\n    if (route.path.indexOf('?') > -1) {\n      let names = route.name.split('-')\n      let paths = route.path.split('/')\n      if (!isChild) {\n        paths.shift()\n      } // clean first / for parents\n      routesIndex.forEach((r) => {\n        let i = r.indexOf('index') - start //  children names\n        if (i < paths.length) {\n          for (let a = 0; a <= i; a++) {\n            if (a === i) {\n              paths[a] = paths[a].replace('?', '')\n            }\n            if (a < i && names[a] !== r[a]) {\n              break\n            }\n          }\n        }\n      })\n      route.path = (isChild ? '' : '/') + paths.join('/')\n    }\n    route.name = route.name.replace(/-index$/, '')\n    if (route.children) {\n      if (route.children.find((child) => child.path === '')) {\n        delete route.name\n      }\n      route.children = cleanChildrenRoutes(route.children, true)\n    }\n  })\n  return routes\n}\n\nexport function createRoutes (files, srcDir) {\n  let routes = []\n  files.forEach((file) => {\n    let keys = file.replace(/^pages/, '').replace(/\\.vue$/, '').replace(/\\/{2,}/g, '/').split('/').slice(1)\n    let route = { name: '', path: '', component: r(srcDir, file) }\n    let parent = routes\n    keys.forEach((key, i) => {\n      route.name = route.name ? route.name + '-' + key.replace('_', '') : key.replace('_', '')\n      route.name += (key === '_') ? 'all' : ''\n      route.chunkName = file.replace(/\\.vue$/, '')\n      let child = _.find(parent, { name: route.name })\n      if (child) {\n        child.children = child.children || []\n        parent = child.children\n        route.path = ''\n      } else {\n        if (key === 'index' && (i + 1) === keys.length) {\n          route.path += (i > 0 ? '' : '/')\n        } else {\n          route.path += '/' + (key === '_' ? '*' : key.replace('_', ':'))\n          if (key !== '_' && key.indexOf('_') !== -1) {\n            route.path += '?'\n          }\n        }\n      }\n    })\n    // Order Routes path\n    parent.push(route)\n    parent.sort((a, b) => {\n      if (!a.path.length || a.path === '/') {\n        return -1\n      }\n      if (!b.path.length || b.path === '/') {\n        return 1\n      }\n      let i = 0\n      let res = 0\n      let y = 0\n      let z = 0\n      const _a = a.path.split('/')\n      const _b = b.path.split('/')\n      for (i = 0; i < _a.length; i++) {\n        if (res !== 0) {\n          break\n        }\n        y = _a[i] === '*' ? 2 : (_a[i].indexOf(':') > -1 ? 1 : 0)\n        z = _b[i] === '*' ? 2 : (_b[i].indexOf(':') > -1 ? 1 : 0)\n        res = y - z\n        // If a.length >= b.length\n        if (i === _b.length - 1 && res === 0) {\n          // change order if * found\n          res = _a[i] === '*' ? -1 : 1\n        }\n      }\n      return res === 0 ? (_a[i - 1] === '*' && _b[i] ? 1 : -1) : res\n    })\n  })\n  return cleanChildrenRoutes(routes)\n}\n","import { cloneDeep } from 'lodash'\nimport { join, resolve } from 'path'\nimport { each } from 'lodash'\nimport { existsSync } from 'fs'\nimport webpack from 'webpack'\nimport nodeExternals from 'webpack-node-externals'\n\nexport default function vuxtraServerConfig (entryFiles) {\n    const nodeModulesDir = join(__dirname, '..', 'node_modules')\n\n    let env = {\n        debug: true\n    }\n    each(this.options.env, (value, key) => {\n        env['process.env.' + key] = (['boolean', 'number'].indexOf(typeof value) !== -1 ? value : JSON.stringify(value))\n    })\n\n  let outputPath = resolve(this.options.buildDir, 'server')\n\n    console.log()\n\n    const config = {\n        name: 'vuxtra-server',\n        target: 'node',\n        node: false,\n        devtool: 'source-map',\n        entry: entryFiles,\n        output: {\n            path: outputPath,\n            filename: '[name].js',\n            chunkFilename: '[name].[chunkhash].js',\n            libraryTarget: 'commonjs2'\n        },\n        performance: {\n            maxEntrypointSize: 1000000,\n            hints: false,\n            maxAssetSize: Infinity\n        },\n        resolve: {\n            extensions: ['.js', '.json', '.ts'],\n            alias: {\n                '~': join(this.options.srcDir),\n                '~~': join(this.options.rootDir),\n                '@': join(this.options.srcDir),\n                '@@': join(this.options.rootDir),\n            },\n            modules: [\n                this.options.modulesDir,\n                nodeModulesDir\n            ]\n        },\n        resolveLoader: {\n            modules: [\n                this.options.modulesDir,\n                nodeModulesDir\n            ]\n        },\n        module: {\n            noParse: /es6-promise\\.js$/, // Avoid webpack shimming process\n            rules: [\n                {\n                    test: /\\.js$/,\n                    loader: 'babel-loader',\n                    exclude: /node_modules/,\n                    options: Object.assign({}, this.babelOptions)\n                },\n            ]\n        },\n        externals: [],\n        plugins: (this.options.build.plugins || []).concat([\n            new webpack.DefinePlugin(Object.assign(env, {\n                debug: true\n            }))\n        ])\n    }\n\n    // Workaround for hiding Warnings about plugins without a default export (#1179)\n    config.plugins.push({\n        apply (compiler) {\n            compiler.plugin('done', stats => {\n                stats.compilation.warnings = stats.compilation.warnings.filter(warn => {\n                    if (warn.name === 'ModuleDependencyWarning' && warn.message.includes(`export 'default'`) && warn.message.includes('plugin')) {\n                        return false\n                    }\n                    return true\n                })\n            })\n        }\n    })\n\n    // https://webpack.js.org/configuration/externals/#externals\n    // https://github.com/liady/webpack-node-externals\n    const moduleDirs = [\n        this.options.modulesDir\n        // Temporary disabled due to vue-server-renderer module search limitations\n        // resolve(__dirname, '..', 'node_modules')\n    ]\n    moduleDirs.forEach(dir => {\n        if (existsSync(dir)) {\n            config.externals.push(nodeExternals({\n                // load non-javascript files with extensions, presumably via loaders\n                whitelist: [/es6-promise|\\.(?!(?:js|json)$).{1,5}$/i],\n                modulesDir: dir\n            }))\n        }\n    })\n\n    // --------------------------------------\n    // Dev specific config\n    // --------------------------------------\n    if (this.options.dev) {\n        //\n    }\n\n    // --------------------------------------\n    // Production specific config\n    // --------------------------------------\n    if (!this.options.dev) {\n        config.plugins.push(\n            new webpack.LoaderOptionsPlugin({\n                minimize: true\n            })\n        )\n    }\n\n    // Clone deep avoid leaking config between Client and Server\n    return cloneDeep(config)\n}\n","import fs, { remove, readFile, writeFile, mkdirp, utimes, existsSync } from 'fs-extra'\nimport Tapable from 'tapable'\nimport chokidar from 'chokidar'\nimport glob from 'glob'\nimport AsyncParallelHook from 'tapable/lib/AsyncParallelHook'\nimport webpack from 'webpack'\nimport { join, resolve, basename, dirname } from 'path'\nimport { r, sequence } from 'nuxt/lib/common/utils'\nimport Exval from 'exval'\n// import MFS from 'memory-fs'\nimport _ from 'lodash'\n\nimport Debug from 'debug'\n\nconst debug = Debug('vuxtra:build')\ndebug.color = 2 // Force green color\n\nimport vuxtraServerWebpackConfig from './webpack/vuxtraServer.config'\n\nexport default class VuxtraBuilder extends Tapable {\n    constructor (_options) {\n        super()\n\n        // setup available hooks\n        this.hooks = {\n            init: new AsyncParallelHook([\"builder\"]),\n            built: new AsyncParallelHook([\"builder\"]),\n            compile: new AsyncParallelHook([\"compiler\"]),\n            pluginDone: new AsyncParallelHook([\"compiler\"]),\n            compileDone: new AsyncParallelHook([\"compiler\"])\n        };\n\n        this.options    = _options\n        this.compiler   = null\n    }\n\n    async build() {\n        debug('...building vuxtraServer')\n        await this.hooks.init.promise(this)\n\n        // Babel options\n        this.babelOptions = _.defaults(this.options.build.babel, {\n            babelrc: false,\n            cacheDirectory: !!this.options.dev\n        })\n        if (!this.babelOptions.babelrc && !this.babelOptions.presets) {\n            this.babelOptions.presets = [\n                require.resolve('babel-preset-vue-app')\n            ]\n        }\n\n        // Check if server dir exists and warn if not\n        if (!fs.existsSync(join(this.options.srcDir, 'server'))) {\n            let dir = this.options.srcDir\n            if (fs.existsSync(resolve(this.options.srcDir, '..', 'server'))) {\n                throw new Error(`No \\`server\\` directory found in ${dir}. Did you mean to run \\`vuxtra\\` in the parent (\\`../\\`) directory?`)\n            } else {\n                throw new Error(`Couldn't find a \\`server\\` directory in ${dir}. Please create one under the project root`)\n            }\n        }\n\n        // lets setup a watcher\n        // this.options.build.watch.push(join(this.options.srcDir, 'server/**/*.js'))\n\n        debug(`App root: ${this.options.srcDir}`)\n        debug(`Generating ${this.options.buildDir} files...`)\n\n        await this.setupBuildDir()\n        await this.buildWebpack()\n\n        await this.hooks.built.promise(this);\n\n    }\n\n    async setupBuildDir() {\n        // Create .vuxtra/, .vuxtra/services and other folders\n        await remove(r(this.options.buildDir))\n        await mkdirp(r(this.options.buildDir, 'server'))\n        if (!this.options.dev) {\n            await mkdirp(r(this.options.buildDir, 'dist'))\n        }\n    }\n\n\n    async generateFiles (entryFiles) {\n        let serviceObj = {}\n        _.forEach(entryFiles, (filePath, path) => {\n\n            let pathSections = _.trim(path, '/').split('/')\n\n            switch (pathSections[0]) {\n                case 'services':\n                    // lets load up file\n\n                    let entryFileObj = {}\n                    let remoteObj = require(join(this.options.buildDir, 'server', _.trimEnd(path,'/')+'.js')).default\n                    _.forIn(remoteObj, (value,key) => {\n                        entryFileObj[key] = path\n                    })\n\n                    // function () {\n                    //     return $_internalService(arguments, this.$__vuxtra_enpoint_options)\n                    // }\n\n                    _.set(serviceObj, _.replace(_.trim(join.apply(null, pathSections.slice(1)), '/'), /\\//g, '.'), entryFileObj)\n                    break\n\n            }\n\n        })\n\n        var templateFn = _.template(`{ <% _.each(model, function(val, index) { %> '<%= index %>' : <% if (_.isObject( val )) { %> <%= templateFn({ model: val, templateFn: templateFn }) %> <% }  else  { %> function () {\n                return $_internalService(arguments, '<%= val %>', '<%= index %>')\n           } <% } %>, <% }); %> }`);\n\n        const fileContent = await readFile(join(__dirname, '../lib/builder/templates/client.js'), 'utf8')\n        const template = _.template(fileContent)\n\n        let exval = new Exval()\n\n        const content = template({\n            serviceObj: templateFn({ model: serviceObj, templateFn: templateFn })\n        })\n\n        let clientPathJs = r(this.options.buildDir, 'clientVuxtra.js')\n        await writeFile(clientPathJs, content, 'utf8')\n\n    }\n\n    async buildWebpack (resetFolders = false) {\n        debug('Building files...')\n        console.log('...compiling vuxtra files')\n        const compilersOptions = []\n\n        if (resetFolders) {\n            await this.setupBuildDir()\n        }\n\n        let entryFiles = glob.sync(`${this.options.srcDir}/server/+(services|models|resources)/**/*.js`).reduce((entries, entry) => Object.assign(entries, {[entry.replace(this.options.srcDir+'/server', '').replace('.js', '')]: entry}), {})\n\n        if (!_.isEmpty(entryFiles)) {\n            // vuxtra default compiler\n            const vuxtraCompilerConfig = vuxtraServerWebpackConfig.call(this, entryFiles)\n            compilersOptions.push(vuxtraCompilerConfig)\n        }\n\n\n        // Simulate webpack multi compiler interface\n        // Separate compilers are simpler, safer and faster\n        this.compiler = { compilers: [] }\n        this.compiler.plugin = (...args) => {\n            this.compiler.compilers.forEach(compiler => {\n                compiler.plugin(...args)\n            })\n        }\n\n        // Initialize shared FS and Cache\n        // const sharedFS = this.options.dev && new MFS()\n        const sharedFS = false // disable shared fs for now\n        const sharedCache = {}\n\n        // Initialize compilers\n        compilersOptions.forEach(compilersOption => {\n            const compiler = webpack(compilersOption)\n            if (sharedFS && !compiler.name.includes('-dll')) {\n                compiler.outputFileSystem = sharedFS\n            }\n            compiler.cache = sharedCache\n            this.compiler.compilers.push(compiler)\n        })\n\n        // Access to compilers with name\n        this.compiler.compilers.forEach(compiler => {\n            if (compiler.name) {\n                this.compiler[compiler.name] = compiler\n            }\n        })\n\n        // Run after each compile\n        this.compiler.plugin('done', async stats => {\n            // Don't reload failed builds\n            if (stats.hasErrors()) {\n                return\n            }\n\n            // console.log(stats.toString({ chunks: true }))\n\n            await this.hooks.pluginDone.promise(this);\n        })\n\n        await this.hooks.compile.promise(this);\n\n        // Start Builds\n        await sequence(this.compiler.compilers, compiler => new Promise((resolve, reject) => {\n            if (this.options.dev) {\n                // Build and watch for changes\n\n                compiler.watch(this.options.watchers.webpack, (err) => {\n                    if (err) {\n                        return reject(err)\n                    }\n                    resolve()\n                })\n\n            } else {\n                // --- Production Build ---\n                compiler.run((err, stats) => {\n                    if (err) {\n                        return reject(err)\n                    }\n\n                    // Show build stats for production\n                    console.log(stats.toString(this.webpackStats)) // eslint-disable-line no-console\n\n                    if (stats.hasErrors()) {\n                        return reject(new Error('Webpack build exited with errors'))\n                    }\n                    resolve()\n                })\n            }\n        }))\n\n\n        await this.generateFiles(entryFiles)\n\n        await this.hooks.compileDone.promise(this);\n\n    }\n\n    watchDev() {\n        const patterns = [\n            r(this.options.srcDir, 'server/services/**/*'),\n        ]\n        const options = Object.assign({}, this.options.watchers.chokidar, {\n            ignoreInitial: true\n        })\n        const refreshWebpack = _.debounce(() => {\n                console.log('refreshing webpack...')\n                this.buildWebpack()\n            }\n            , 2000\n        )\n\n        const refreshWebpackReset = _.debounce(() => {\n                this.buildWebpack(true)\n            }\n            , 2000\n        )\n\n        // Watch for src Files\n        let filesWatcher = chokidar.watch(patterns, options)\n            .on('add', refreshWebpack)\n            .on('unlink', refreshWebpackReset)\n            .on('change', refreshWebpack)\n\n    }\n}","import express from 'express'\nimport path from 'path'\nimport morgan from 'morgan'\nimport healthChecker from 'sc-framework-health-check'\nimport Debug from 'debug'\nimport { Nuxt, Builder as NuxtBuilder} from 'nuxt'\nimport VuxtraServer from './../vuxtraserver/vuxtraServer'\nimport VuxtraBuilder from './../builder'\nimport _ from 'lodash'\n\n\nconst debug = Debug('scc-worker:')\ndebug.color = 5\n\n\nmodule.exports.run = function (worker) {\n    debug('   >> Worker PID:', process.pid)\n    var environment = worker.options.environment\n\n    var app = express()\n\n    var httpServer = worker.httpServer\n    var scServer = worker.scServer\n\n    process.on('unhandledRejection', (reason, p) => {\n        console.log('Unhandled Rejection at: Promise', p, 'reason:', reason);\n        worker.sendToMaster({type: 'error', subtype: 'worker', e:p, message: reason})\n    });\n\n    if (environment == 'dev') {\n        // Log every HTTP request. See https://github.com/expressjs/morgan for other\n        // available formats.\n        app.use(morgan('dev'))\n    }\n\n    // Import and Set vuxtra and nuxt options\n    let config = worker.options.__full_deep_temp_options\n\n    if (!_.isArray(config.nuxt.modules)) {\n        config.nuxt.modules = []\n    }\n\n    // main vuxtra module\n    config.nuxt.modules.push(\n        {\n            src:  '@vuxtra/nuxt-client-module/lib/index',\n            options: config\n        })\n\n    if (!_.isArray(config.nuxt.build)) {\n        config.nuxt.build = []\n\n        if (!_.isArray(config.nuxt.build.templates)) {\n            config.nuxt.build.templates = []\n        }\n    }\n\n    config.nuxt.build.templates.push('./.vuxtra/clientVuxtra.js')\n\n    // Init Nuxt.js\n    const nuxt = new Nuxt(config.nuxt)\n\n    let builderPromise = new Promise((resolve, reject) => {\n\n        // Build only in dev mode\n        if (config.vuxtra.dev) {\n            const vuxtraBuilder = new VuxtraBuilder(config.vuxtra)\n            vuxtraBuilder.build().then(() => {\n                worker.sendToMaster({type: 'event', subtype: 'vuxtraBuilt', message: 'Vuxtra has been built'})\n                vuxtraBuilder.watchDev()\n                // Build only in dev mode\n                if (config.nuxt.dev) {\n                    const nuxtBuilder = new NuxtBuilder(nuxt)\n                    nuxtBuilder.build().then(() => {\n                        worker.sendToMaster({type: 'event', subtype: 'nuxtBuilt', message: 'nuxt has been built'})\n                        resolve('true')\n                    })\n                }\n            }).catch((e) => {\n                worker.sendToMaster({type: 'error', subtype: 'builders', 'e':e, message: e.message})\n                reject(e)\n            })\n        }\n        else {\n            resolve(true)\n        }\n\n    })\n\n    builderPromise.then(() => {\n\n        // Give nuxt middleware to express\n        app.use(nuxt.render)\n\n        // Add GET /health-check express route\n        healthChecker.attach(worker, app)\n        httpServer.on('request', app)\n\n        var count = 0\n\n        let vuxtraServer = new VuxtraServer(config.vuxtra)\n\n        // lets register current socket with vuxtraServer\n        vuxtraServer.registerSocketServer(scServer)\n        // lets run it\n        vuxtraServer.run()\n\n        worker.sendToMaster({type: 'event', subtype: 'vuxtraStarted', message: 'vuxtra has started'})\n\n    })\n\n}\n"],"names":["Controller","Tapable","_options","_session","options","session","ServiceController","data","res","request","ServiceRequest","response","ServiceResponse","setId","getId","ssSuccess","setServiceName","getServiceName","setServiceAction","getServiceAction","type","getType","ssClientErrorInvalidRequest","absoluteServicePath","join","buildDir","service","require","resolve","default","ssClientErrorNotFound","ctx","Promise","apply","_","values","getData","then","result","setData","e","code","ssServerError","message","AuthToken","rawToken","v","uid","sid","ct","require$$0","rng","bytesToUuid","Session","socket","authToken","_socket","log","getAuthToken","setSessionId","uuidv4","userUUID","setUserId","getUserId","getSessionId","VuxtraServer","hooks","AsyncParallelHook","socketServer","serviceController","hasIn","Error","init","promise","on","socketConnection","processServiceRequest","ready","setAuthToken","currentAuthTokenVersion","process","sep","vuxtraServerConfig","entryFiles","nodeModulesDir","__dirname","env","value","key","indexOf","JSON","stringify","outputPath","config","Infinity","srcDir","rootDir","modulesDir","Object","assign","babelOptions","build","plugins","concat","webpack","DefinePlugin","push","compiler","plugin","stats","compilation","warnings","filter","warn","name","includes","moduleDirs","forEach","dir","existsSync","externals","nodeExternals","dev","LoaderOptionsPlugin","cloneDeep","debug","Debug","color","VuxtraBuilder","defaults","babel","babelrc","presets","fs","setupBuildDir","buildWebpack","built","remove","r","mkdirp","serviceObj","filePath","path","pathSections","trim","split","entryFileObj","remoteObj","trimEnd","forIn","set","replace","slice","templateFn","template","fileContent","readFile","exval","Exval","content","model","clientPathJs","writeFile","resetFolders","compilersOptions","glob","sync","reduce","entries","entry","isEmpty","vuxtraCompilerConfig","vuxtraServerWebpackConfig","call","compilers","args","sharedFS","sharedCache","compilersOption","outputFileSystem","cache","hasErrors","pluginDone","compile","sequence","reject","watch","watchers","err","run","toString","webpackStats","generateFiles","compileDone","patterns","chokidar","refreshWebpack","debounce","refreshWebpackReset","filesWatcher","module","exports","worker","pid","environment","app","express","httpServer","scServer","reason","p","sendToMaster","subtype","use","morgan","__full_deep_temp_options","isArray","nuxt","modules","templates","Nuxt","builderPromise","vuxtra","vuxtraBuilder","watchDev","nuxtBuilder","NuxtBuilder","catch","render","attach","vuxtraServer","registerSocketServer"],"mappings":"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"}